# תיקוני כספית - ייבוא וקיזוז חשבוניות עסקה

## תיאור הבעיות שתוקנו

### בעיה 1: תבנית הייבוא חסרה שדות קריטיים
**הבעיה:** תבנית ה-CSV המקורית לא כללה עמודות לסוג מסמך, קישור חשבוניות ותנאי תשלום.

**הפתרון:** תמיכה בשני פורמטים:
1. **פורמט CRM** - ייבוא ישיר מהקובץ שמייצא ה-CRM (ללא שינויים!)
2. **פורמט סטנדרטי** - תבנית עם שמות עמודות באנגלית

## ייבוא ישיר מה-CRM (מומלץ!)

המערכת מזהה אוטומטית את הפורמט של ה-CRM שלך.

### עמודות נתמכות מה-CRM:
| עמודה ב-CRM | מה המערכת עושה איתה |
|-------------|---------------------|
| מספר המסמך | מספר מסמך |
| סוג מסמך | סוג המסמך (חשבון עיסקה, חשבונית מס, וכו') |
| שם הלקוח | התאמה לרשימת הלקוחות + קישור אוטומטי |
| תאריך המסמך | תאריך (ממיר אוטומטית DD.MM.YYYY) |
| סטטוס | סטטוס מסמך (פתוח/סגור) |
| חשבונית ללא מע"מ | סכום לפני מע"מ |
| מוכר מע"מ | סכום המע"מ |
| חשבונית רגילה | סכום כולל |

### סוגי מסמכים נתמכים:
| מה-CRM | בכספית |
|--------|--------|
| חשבון עיסקה | חשבונית עסקה |
| חשבונית מס | חשבונית מס |
| חשבונית מס קבלה | חשבונית מס קבלה |
| קבלה | קבלה |
| חשבונית זיכוי | הודעת זיכוי |

### בעיה 2: לוגיקת הייבוא לא תומכת בקיזוז
**הבעיה:** כל המסמכים המיובאים נשמרו ללא קישור בין חשבון עיסקה לחשבונית מס/קבלה.

**הפתרון:** קיזוז אוטומטי **זהיר**:
- קישור אוטומטי **רק** כשיש התאמה יחידה (לקוח + סכום)
- אם יש 0 או 2+ התאמות → נשאר לקישור ידני
- חשבון עיסקה נסגר אוטומטית כשמקושר

### בעיה 3: פורמט תאריך לא תואם
**הבעיה:** ה-CRM מייצא תאריכים בפורמט DD.MM.YYYY

**הפתרון:** המרה אוטומטית של פורמט התאריך.

---

## קבצים מעודכנים

```
kaspit-fixes/
├── templates/
│   └── income-template.csv          # תבנית CSV מעודכנת
├── public/
│   └── templates/
│       └── income-template.csv      # תבנית ל-public
├── app/
│   └── (dashboard)/
│       └── income/
│           └── page.tsx             # דף הכנסות עם לוגיקת קיזוז
└── README.md                        # קובץ זה
```

---

## אופן ההתקנה

1. **גיבוי הקבצים הקיימים** (מומלץ!)

2. **העתקת הקבצים:**
   ```bash
   # העתק את התבניות
   cp kaspit-fixes/templates/income-template.csv your-project/templates/
   cp kaspit-fixes/public/templates/income-template.csv your-project/public/templates/
   
   # העתק את דף ההכנסות
   cp kaspit-fixes/app/\(dashboard\)/income/page.tsx your-project/app/\(dashboard\)/income/
   ```

3. **בדיקה:** ודאי שהאפליקציה עולה ללא שגיאות

---

## שימוש בתכונה החדשה

### ייבוא ישיר מה-CRM

פשוט מייצאים את הקובץ מה-CRM ומייבאים אותו כמו שהוא!

**מה יקרה:**
1. כל המסמכים יובאו עם הסוג הנכון
2. חשבונות עיסקה יהיו בסטטוס "פתוח" או "סגור" לפי ה-CRM
3. **קישור אוטומטי זהיר** - רק אם יש התאמה יחידה של לקוח + סכום
4. מסמכים עם 0 או 2+ התאמות → נשארים לקישור ידני דרך הממשק

### דוגמה לתוצאות קישור:

```
✅ קושר אוטומטית:
   חשבון עיסקה 6774 (דרור לבהר, ₪1,416) ← חשבונית מס קבלה 6850

⏸️ לא קושר (2 התאמות - לקישור ידני):
   חשבון עיסקה 6773 (רטנר נבו, ₪472) ← חשבונית מס קבלה 6853 או 6943?

❌ לא קושר (0 התאמות):
   חשבון עיסקה 6791 (יעקב נרדיה, ₪2,528) ← אין חשבונית מס תואמת
```

### קישור ידני

לחשבונות עיסקה שלא קושרו אוטומטית:
1. לחצי על אייקון הקישור 🔗 ליד חשבון העיסקה
2. בחרי את חשבונית המס/קבלה המתאימה מהרשימה
3. הקישור יתבצע וחשבון העיסקה ייסגר

### ערכים אפשריים לסוג מסמך

| עברית | אנגלית |
|-------|--------|
| חשבונית עסקה | invoice |
| חשבונית מס | tax_invoice |
| חשבונית מס קבלה | tax_invoice_receipt |
| קבלה | receipt |
| הודעת זיכוי | credit_note |

### ערכים אפשריים לסטטוס

| עברית | אנגלית |
|-------|--------|
| ממתין | pending |
| שולם חלקית | partial |
| שולם | paid |

### ערכים אפשריים לתנאי תשלום

| עברית | אנגלית | הסבר |
|-------|--------|------|
| מיידי | immediate | תשלום מיידי |
| שוטף | eom | סוף החודש |
| שוטף + 30 | eom_plus_30 | סוף החודש + 30 יום |
| שוטף + 45 | eom_plus_45 | סוף החודש + 45 יום |
| שוטף + 60 | eom_plus_60 | סוף החודש + 60 יום |
| שוטף + 90 | eom_plus_90 | סוף החודש + 90 יום |
| 30 יום | net_30 | 30 יום מתאריך החשבונית |
| 45 יום | net_45 | 45 יום מתאריך החשבונית |
| 60 יום | net_60 | 60 יום מתאריך החשבונית |

**הערה:** אם מציינים תנאי תשלום ולא תאריך לתשלום - המערכת תחשב את התאריך אוטומטית.

---

## פונקציות חדשות בקוד

### `performAutoLinking`
קישור אוטומטי של חשבוניות מס לחשבוניות עסקה לאחר הייבוא.

### `findSmartMatch`
התאמה חכמה לפי סכום, לקוח ותאריך כאשר לא צוין קישור ישיר.

---

## הערות נוספות

- **התאמה חכמה** עובדת רק אם יש התאמה יחידה וברורה
- **הודעת הצלחה** מפרטת כמה מסמכים קושרו אוטומטית
- **חשבוניות עסקה קיימות** במערכת גם נלקחות בחשבון בקיזוז

---

## תמיכה

בעיות? שאלות? פני לצוות הפיתוח.
