# תיקוני כספית - ייבוא וקיזוז חשבוניות עסקה

## תיאור הבעיות שתוקנו

### בעיה 1: תבנית הייבוא חסרה שדות קריטיים
**הבעיה:** תבנית ה-CSV המקורית לא כללה עמודות לסוג מסמך ולקישור חשבוניות.

**הפתרון:** תבנית חדשה עם העמודות הבאות:
- תאריך
- סכום (לפני מע״מ)
- תיאור
- מספר מסמך
- **סוג מסמך** (חדש!) - חשבונית עסקה / חשבונית מס / חשבונית מס קבלה
- **מספר חשבונית עסקה מקושרת** (חדש!) - לקיזוז אוטומטי
- **לקוח** (חדש!) - להתאמה חכמה
- פטור ממע״מ
- סטטוס

### בעיה 2: לוגיקת הייבוא לא תומכת בקיזוז
**הבעיה:** כל המסמכים המיובאים נשמרו כ-"חשבונית מס" ללא אפשרות קישור.

**הפתרון:** פונקציית `handleImport` חדשה שכוללת:
1. **קיזוז אוטומטי לפי מספר מסמך** - אם צוין מספר חשבונית עסקה מקושרת
2. **התאמה חכמה** - אם לא צוין קישור, המערכת מחפשת התאמה לפי:
   - סכום זהה (עד סטייה של 1 ש"ח)
   - אותו לקוח
   - תאריכים קרובים (עד 60 יום)

### בעיה 3: שדות חובה לא נכונים
**הבעיה:** "סוג מסמך" היה מוגדר כאופציונלי.

**הפתרון:** סוג מסמך הפך לשדה חובה (`required: true`).

---

## קבצים מעודכנים

```
kaspit-fixes/
├── templates/
│   └── income-template.csv          # תבנית CSV מעודכנת
├── public/
│   └── templates/
│       └── income-template.csv      # תבנית ל-public
├── app/
│   └── (dashboard)/
│       └── income/
│           └── page.tsx             # דף הכנסות עם לוגיקת קיזוז
└── README.md                        # קובץ זה
```

---

## אופן ההתקנה

1. **גיבוי הקבצים הקיימים** (מומלץ!)

2. **העתקת הקבצים:**
   ```bash
   # העתק את התבניות
   cp kaspit-fixes/templates/income-template.csv your-project/templates/
   cp kaspit-fixes/public/templates/income-template.csv your-project/public/templates/
   
   # העתק את דף ההכנסות
   cp kaspit-fixes/app/\(dashboard\)/income/page.tsx your-project/app/\(dashboard\)/income/
   ```

3. **בדיקה:** ודאי שהאפליקציה עולה ללא שגיאות

---

## שימוש בתכונה החדשה

### ייבוא עם קיזוז אוטומטי

**דוגמה לקובץ CSV:**
```csv
תאריך,סכום (לפני מע״מ),תיאור,מספר מסמך,סוג מסמך,מספר חשבונית עסקה מקושרת,לקוח,פטור ממע״מ,סטטוס
2024-01-15,5000,ייעוץ עסקי,1001,חשבונית עסקה,,,לא,ממתין
2024-01-20,5000,ייעוץ עסקי - קבלה,1002,חשבונית מס קבלה,1001,,לא,שולם
```

**מה יקרה:**
1. חשבונית עסקה 1001 תיווצר בסטטוס "פתוח"
2. חשבונית מס קבלה 1002 תיווצר ותקושר ל-1001
3. חשבונית עסקה 1001 תעבור אוטומטית לסטטוס "סגור"

### ערכים אפשריים לסוג מסמך

| עברית | אנגלית |
|-------|--------|
| חשבונית עסקה | invoice |
| חשבונית מס | tax_invoice |
| חשבונית מס קבלה | tax_invoice_receipt |
| קבלה | receipt |
| הודעת זיכוי | credit_note |

### ערכים אפשריים לסטטוס

| עברית | אנגלית |
|-------|--------|
| ממתין | pending |
| שולם חלקית | partial |
| שולם | paid |

---

## פונקציות חדשות בקוד

### `performAutoLinking`
קישור אוטומטי של חשבוניות מס לחשבוניות עסקה לאחר הייבוא.

### `findSmartMatch`
התאמה חכמה לפי סכום, לקוח ותאריך כאשר לא צוין קישור ישיר.

---

## הערות נוספות

- **התאמה חכמה** עובדת רק אם יש התאמה יחידה וברורה
- **הודעת הצלחה** מפרטת כמה מסמכים קושרו אוטומטית
- **חשבוניות עסקה קיימות** במערכת גם נלקחות בחשבון בקיזוז

---

## תמיכה

בעיות? שאלות? פני לצוות הפיתוח.
